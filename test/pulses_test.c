/*
  svn: $Id$

  test the pulse metadata code - output from this can be plotted by pulses_test.R 
*/

#include <stdio.h>
#include <unistd.h>
#define _GNU_SOURCE 1
#include <math.h>
#include "../main/statefun.c"
#include "../main/pulses.c"

// comment out the following line for a complicated example
#define SIMPLE_EXAMPLE

int
main(int argc, char *argv[]) {

  unsigned i;

#ifdef SIMPLE_EXAMPLE

  // rotation around x axis, tilt 30 degrees

  //                             azi  elev                            
  double rot_axis_approx[]   = { 90.0, 0.0};

  double tilt_angle_approx[] = { 30.0};


#else

  // rotation axis and tilt angle both change

  //                             azi  elev   t
  double rot_axis_approx[]  = {  0.0, 90.0, 0.0,
			        90.0, 60.0, 0.5,
			        45.0, 90.0, 1.0,
				22.5, 60.0, 1.5,
			         0.0, 90.0, 2.0
  };

  //                             tilt   t
  double tilt_angle_approx[] = { 45.0, 0.0,
				 85.0, 0.25,
				 45.0, 0.5,
				  5.0, 0.75,
				 45.0, 1.0,
				 85.0, 1.25,
				 45.0, 1.5,
				  5.0, 1.75,
				 45.0, 2.0
  };


#endif /* SIMPLE_EXAMPLE */

  // orientation of scan:  +1 = clockwise, -1 = CCW
  double scan_orientation = +1;

  // time range from 0 to 2 seconds in 0.5 second steps
  double t_start = 0.0;
  double t_step  = 0.01;
  unsigned n_time = 200;

  double ang_offset = 0.0;

  double ts[n_time];
  double azi[n_time];
  double elev[n_time];
  double wg_azi[n_time];
  double wg_elev[n_time];

  // the NA value used by R

  unsigned R_NA_NaN_words[] = {1954, 0x7ff00000};
  double R_NA_NaN = * (double *) R_NA_NaN_words;

  get_pulse_metadata(n_time, t_start, n_time * t_step, scan_orientation, ang_offset,
		     rot_axis_approx, sizeof(rot_axis_approx) / sizeof(double),
		     tilt_angle_approx, sizeof(tilt_angle_approx) / sizeof(double),
		     ts, azi, elev, wg_azi, wg_elev, R_NA_NaN);

  puts ("time     azi        elev       wg_azi    wg_elev");
  for (i = 0; i < n_time; ++i)
    printf ("%5.3f %10.3f %10.3f %10.3f %10.3f\n", ts[i], azi[i], elev[i], wg_azi[i], wg_elev[i]);

  return 0;
}

/* output should be:

time     azi        elev       wg_azi    wg_elev
0.000     30.000     -0.000    180.000    -90.000
0.010     30.012     -1.559    180.000    -88.200
0.020     30.049     -3.117    180.000    -86.400
0.030     30.110     -4.675    180.000    -84.600
0.040     30.197     -6.231    180.000    -82.800
0.050     30.308     -7.786    180.000    -81.000
0.060     30.445     -9.339    180.000    -79.200
0.070     30.608    -10.890    180.000    -77.400
0.080     30.798    -12.437    180.000    -75.600
0.090     31.015    -13.982    180.000    -73.800
0.100     31.260    -15.522    180.000    -72.000
0.110     31.534    -17.059    180.000    -70.200
0.120     31.838    -18.591    180.000    -68.400
0.130     32.174    -20.117    180.000    -66.600
0.140     32.541    -21.638    180.000    -64.800
0.150     32.942    -23.152    180.000    -63.000
0.160     33.379    -24.659    180.000    -61.200
0.170     33.852    -26.158    180.000    -59.400
0.180     34.364    -27.648    180.000    -57.600
0.190     34.917    -29.129    180.000    -55.800
0.200     35.513    -30.600    180.000    -54.000
0.210     36.155    -32.059    180.000    -52.200
0.220     36.844    -33.506    180.000    -50.400
0.230     37.585    -34.940    180.000    -48.600
0.240     38.380    -36.358    180.000    -46.800
0.250     39.232    -37.761    180.000    -45.000
0.260     40.144    -39.146    180.000    -43.200
0.270     41.122    -40.513    180.000    -41.400
0.280     42.169    -41.858    180.000    -39.600
0.290     43.289    -43.180    180.000    -37.800
0.300     44.487    -44.478    180.000    -36.000
0.310     45.768    -45.748    180.000    -34.200
0.320     47.136    -46.988    180.000    -32.400
0.330     48.598    -48.196    180.000    -30.600
0.340     50.158    -49.368    180.000    -28.800
0.350     51.821    -50.501    180.000    -27.000
0.360     53.592    -51.592    180.000    -25.200
0.370     55.477    -52.636    180.000    -23.400
0.380     57.478    -53.631    180.000    -21.600
0.390     59.599    -54.570    180.000    -19.800
0.400     61.843    -55.451    180.000    -18.000
0.410     64.209    -56.267    180.000    -16.200
0.420     66.696    -57.015    180.000    -14.400
0.430     69.302    -57.690    180.000    -12.600
0.440     72.019    -58.286    180.000    -10.800
0.450     74.840    -58.800    180.000     -9.000
0.460     77.752    -59.226    180.000     -7.200
0.470     80.742    -59.562    180.000     -5.400
0.480     83.793    -59.805    180.000     -3.600
0.490     86.886    -59.951    180.000     -1.800
0.500     90.000    -60.000    180.000     -0.000
0.510     93.114    -59.951    180.000      1.800
0.520     96.207    -59.805    180.000      3.600
0.530     99.258    -59.562    180.000      5.400
0.540    102.248    -59.226    180.000      7.200
0.550    105.160    -58.800    180.000      9.000
0.560    107.981    -58.286    180.000     10.800
0.570    110.698    -57.690    180.000     12.600
0.580    113.304    -57.015    180.000     14.400
0.590    115.791    -56.267    180.000     16.200
0.600    118.157    -55.451    180.000     18.000
0.610    120.401    -54.570    180.000     19.800
0.620    122.522    -53.631    180.000     21.600
0.630    124.523    -52.636    180.000     23.400
0.640    126.408    -51.592    180.000     25.200
0.650    128.179    -50.501    180.000     27.000
0.660    129.842    -49.368    180.000     28.800
0.670    131.402    -48.196    180.000     30.600
0.680    132.864    -46.988    180.000     32.400
0.690    134.232    -45.748    180.000     34.200
0.700    135.513    -44.478    180.000     36.000
0.710    136.711    -43.180    180.000     37.800
0.720    137.831    -41.858    180.000     39.600
0.730    138.878    -40.513    180.000     41.400
0.740    139.856    -39.146    180.000     43.200
0.750    140.768    -37.761    180.000     45.000
0.760    141.620    -36.358    180.000     46.800
0.770    142.415    -34.940    180.000     48.600
0.780    143.156    -33.506    180.000     50.400
0.790    143.845    -32.059    180.000     52.200
0.800    144.487    -30.600    180.000     54.000
0.810    145.083    -29.129    180.000     55.800
0.820    145.636    -27.648    180.000     57.600
0.830    146.148    -26.158    180.000     59.400
0.840    146.621    -24.659    180.000     61.200
0.850    147.058    -23.152    180.000     63.000
0.860    147.459    -21.638    180.000     64.800
0.870    147.826    -20.117    180.000     66.600
0.880    148.162    -18.591    180.000     68.400
0.890    148.466    -17.059    180.000     70.200
0.900    148.740    -15.522    180.000     72.000
0.910    148.985    -13.982    180.000     73.800
0.920    149.202    -12.437    180.000     75.600
0.930    149.392    -10.890    180.000     77.400
0.940    149.555     -9.339    180.000     79.200
0.950    149.692     -7.786    180.000     81.000
0.960    149.803     -6.231    180.000     82.800
0.970    149.890     -4.675    180.000     84.600
0.980    149.951     -3.117    180.000     86.400
0.990    149.988     -1.559    180.000     88.200
1.000    150.000     -0.000    180.000     90.000
1.010    149.988      1.559      0.000     88.200
1.020    149.951      3.117      0.000     86.400
1.030    149.890      4.675      0.000     84.600
1.040    149.803      6.231      0.000     82.800
1.050    149.692      7.786      0.000     81.000
1.060    149.555      9.339      0.000     79.200
1.070    149.392     10.890      0.000     77.400
1.080    149.202     12.437      0.000     75.600
1.090    148.985     13.982      0.000     73.800
1.100    148.740     15.522      0.000     72.000
1.110    148.466     17.059      0.000     70.200
1.120    148.162     18.591      0.000     68.400
1.130    147.826     20.117      0.000     66.600
1.140    147.459     21.638      0.000     64.800
1.150    147.058     23.152      0.000     63.000
1.160    146.621     24.659      0.000     61.200
1.170    146.148     26.158      0.000     59.400
1.180    145.636     27.648      0.000     57.600
1.190    145.083     29.129      0.000     55.800
1.200    144.487     30.600      0.000     54.000
1.210    143.845     32.059      0.000     52.200
1.220    143.156     33.506      0.000     50.400
1.230    142.415     34.940      0.000     48.600
1.240    141.620     36.358      0.000     46.800
1.250    140.768     37.761      0.000     45.000
1.260    139.856     39.146      0.000     43.200
1.270    138.878     40.513      0.000     41.400
1.280    137.831     41.858      0.000     39.600
1.290    136.711     43.180      0.000     37.800
1.300    135.513     44.478      0.000     36.000
1.310    134.232     45.748      0.000     34.200
1.320    132.864     46.988      0.000     32.400
1.330    131.402     48.196      0.000     30.600
1.340    129.842     49.368      0.000     28.800
1.350    128.179     50.501      0.000     27.000
1.360    126.408     51.592      0.000     25.200
1.370    124.523     52.636      0.000     23.400
1.380    122.522     53.631      0.000     21.600
1.390    120.401     54.570      0.000     19.800
1.400    118.157     55.451      0.000     18.000
1.410    115.791     56.267      0.000     16.200
1.420    113.304     57.015      0.000     14.400
1.430    110.698     57.690      0.000     12.600
1.440    107.981     58.286      0.000     10.800
1.450    105.160     58.800      0.000      9.000
1.460    102.248     59.226      0.000      7.200
1.470     99.258     59.562      0.000      5.400
1.480     96.207     59.805      0.000      3.600
1.490     93.114     59.951      0.000      1.800
1.500     90.000     60.000      0.000      0.000
1.510     86.886     59.951      0.000     -1.800
1.520     83.793     59.805      0.000     -3.600
1.530     80.742     59.562      0.000     -5.400
1.540     77.752     59.226      0.000     -7.200
1.550     74.840     58.800      0.000     -9.000
1.560     72.019     58.286      0.000    -10.800
1.570     69.302     57.690      0.000    -12.600
1.580     66.696     57.015      0.000    -14.400
1.590     64.209     56.267      0.000    -16.200
1.600     61.843     55.451      0.000    -18.000
1.610     59.599     54.570      0.000    -19.800
1.620     57.478     53.631      0.000    -21.600
1.630     55.477     52.636      0.000    -23.400
1.640     53.592     51.592      0.000    -25.200
1.650     51.821     50.501      0.000    -27.000
1.660     50.158     49.368      0.000    -28.800
1.670     48.598     48.196      0.000    -30.600
1.680     47.136     46.988      0.000    -32.400
1.690     45.768     45.748      0.000    -34.200
1.700     44.487     44.478      0.000    -36.000
1.710     43.289     43.180      0.000    -37.800
1.720     42.169     41.858      0.000    -39.600
1.730     41.122     40.513      0.000    -41.400
1.740     40.144     39.146      0.000    -43.200
1.750     39.232     37.761      0.000    -45.000
1.760     38.380     36.358      0.000    -46.800
1.770     37.585     34.940      0.000    -48.600
1.780     36.844     33.506      0.000    -50.400
1.790     36.155     32.059      0.000    -52.200
1.800     35.513     30.600      0.000    -54.000
1.810     34.917     29.129      0.000    -55.800
1.820     34.364     27.648      0.000    -57.600
1.830     33.852     26.158      0.000    -59.400
1.840     33.379     24.659      0.000    -61.200
1.850     32.942     23.152      0.000    -63.000
1.860     32.541     21.638      0.000    -64.800
1.870     32.174     20.117      0.000    -66.600
1.880     31.838     18.591      0.000    -68.400
1.890     31.534     17.059      0.000    -70.200
1.900     31.260     15.522      0.000    -72.000
1.910     31.015     13.982      0.000    -73.800
1.920     30.798     12.437      0.000    -75.600
1.930     30.608     10.890      0.000    -77.400
1.940     30.445      9.339      0.000    -79.200
1.950     30.308      7.786      0.000    -81.000
1.960     30.197      6.231      0.000    -82.800
1.970     30.110      4.675      0.000    -84.600
1.980     30.049      3.117      0.000    -86.400
1.990     30.012      1.559      0.000    -88.200
*/
